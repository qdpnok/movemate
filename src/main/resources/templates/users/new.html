<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{/layout/login}">

<head>
  <meta charset="UTF-8" />
  <title>sign up</title>
</head>

<body>
  <div layout:fragment="content">
    <div id="signup-container">
      <h1>회원가입</h1>

      <!-- 좌측: 현재/미리보기 아바타 -->
      <div class="profile-left">
        <div class="avatar-box">
          <img id="avatarPreview" class="avatar img-round-big" th:src="${userForm.profileImageUrl} != null ?
                        @{/files/{file}(file=${userForm.profileImageUrl})} :
                        @{/images/profile.png}" alt="프로필 미리보기" />
        </div>
      </div>

      <!-- th:로 시작하는 것들은 thymeleaf 문법을 사용했다는 의미 -->

      <!-- @{경로} : form이 작동하면 해당 경로로 요청한다 -->

      <!-- th:object="${이름}" model.addAttribute 로 넘겨준 객체를 사용한다. -->
      <!-- model.addAttribute("이름", 객체) 의 이름과 th:object = "${이름}" 의 이름이 동일해야 함-->

      <!-- method="post" 해당 경로로 요청을 보낼 때 post 방식을 사용해서 요청을 보내겠다 -->
      <!-- 기본값은 get 입니다. -->
      <form th:action="@{/users/new}" th:object="${userForm}" method="post" enctype="multipart/form-data">
        <div class="input-box">

          <div id="signup">
            <label id="label-signup-profile" for="profileImageInput">
              <button type="button" id="btn-upload-profile">프로필 사진 업로드</button>
              <input id="profileImageInput" class="input" type="file" name="profileImage" accept="image/*" />
            </label>
            <div class="hint">JPG/PNG/WebP 권장, 5MB 이하</div>
          </div>

          <!-- th:field="*{필드이름}" : 객체의 "필드이름" 필드에 값을 넣겠다는 의미 -->
          <!-- 앞의 별은 부모의 객체 (여기서는 ${memberForm}을 의미함) 을 선택했다는 뜻입니다.-->
          <input type="text" class="input-name input-txt" th:field="*{name}" placeholder="이름" required />
          <p class="signup-check"></p>
        </div>
        <div class="input-box">
          <input type="text" class="input-id input-txt" th:field="*{userId}" placeholder="아이디" required />
          <p class="signup-check check-id"></p>
        </div>
        <div class="input-box">
          <input type="email" class="input-email input-txt" th:field="*{email}" placeholder="이메일" required />
          <p class="signup-check check-email"></p>
        </div>
        <div class="input-box">
          <input type="password" class="input-pwd input-txt" th:field="*{password}" placeholder="비밀번호" required />
          <p class="signup-check check-pwd"></p>
        </div>
        <div class="input-box">
          <input type="password" class="input-pwd-check input-txt" placeholder="비밀번호 확인" required />
          <p class="signup-check check-pwd-check"></p>
        </div>
        <div class="input-box">
          <input type="tel" class="input-tel input-txt" th:field="*{phoneNo}" placeholder="휴대폰번호" required />
          <p class="signup-check check-tel"></p>
        </div>
        <div>
          <label>
            <select id="new_select" name="region" class="region" th:field="*{region}" required>
              <option disabled hidden="hidden" selected value="">지역 선택</option>
            </select>
          </label>
        </div>
        <div class="signup-box">
          <div id="signup-box-gender">
            <label class="type-label" for="male">성별</label>
            <div class="choice">
              <input type="radio" name="gender" id="male" th:field="*{gender}" value="남성" />
              남
            </div>
            <div class="choice">
              <input type="radio" name="gender" id="female" th:field="*{gender}" value="여성" />
              여
            </div>
          </div>
          <div id="signup-box-age">
            <label class="type-label" for="age">나이</label>
            <input type="text" id="age" th:field="*{age}" placeholder="만나이 입력 ex)25세" />
          </div>
        </div>
        <div class="signup-box">
          <label class="type-label" for="sportR">운동 종목</label>
          <div class="choice">
            <input type="radio" name="sport" id="sportR" th:field="*{sportType}" value="러닝" />러닝
          </div>
          <div class="choice">
            <input type="radio" name="sport" id="sportW" th:field="*{sportType}" value="웨이트" />웨이트
          </div>
          <div class="choice">
            <input type="radio" name="sport" id="sportA" th:field="*{sportType}" value="모두" />모두 선택
          </div>
        </div>
        <div id="signup-box-pace">
          <p>러닝 페이스 입력</p>
          <input type="text" class="input-txt" th:field="*{paceDetail}" placeholder="MM:ss" />
        </div>
        <button id="signup-button" type="submit" disabled>회원가입</button>
      </form>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
            // -------------------- API 설정 --------------------
            // **주의: REST API 키는 서버 측에서 안전하게 관리하는 것이 좋습니다.**
            const KAKAO_REST_API_KEY = "d3a833eb2f6b0ab6fbf1d77ef93348aa";
            const SEARCH_KEYWORD = "천안시";
            const API_URL = "https://dapi.kakao.com/v2/local/search/keyword.json";
            const MAX_PAGES = 45; // 카카오 API 검색 페이지 수 제한 (최대 45)

            // DOM 요소 접근 (DOMContentLoaded 안에서 접근해야 null 오류가 발생하지 않습니다)
            const dropdown = document.getElementById("new_select");

            if (!dropdown) {
                console.error("오류: Select 박스 (ID: new_select)를 찾을 수 없습니다.");
                return; // 드롭다운이 없으면 나머지 로직 실행 중지
            }
            
            // 드롭다운 초기 상태 설정
            dropdown.disabled = true;

            // -------------------- 데이터 수집 로직 --------------------
            /**
             * 카카오 API를 재귀적으로 호출하여 모든 페이지의 지역 데이터를 수집합니다.
             * @param {string} keyword - 검색할 키워드 (예: "천안시")
             * @param {number} page - 현재 페이지 번호
             * @param {Set<string>} districts - 수집된 고유한 읍면동 이름을 저장하는 Set
             * @returns {Promise<Set<string>>} - 수집된 지역 Set
             */
            async function fetchAllDistricts(keyword, page, districts) {
                if (page > MAX_PAGES) {
                    console.warn(`최대 페이지 수(${MAX_PAGES}페이지)에 도달하여 검색을 중단합니다.`);
                    return districts;
                }

                const query = new URLSearchParams({
                    query: keyword,
                    page: page,
                    size: 15
                }).toString();

                try {
                    const response = await fetch(`${API_URL}?${query}`, {
                        method: 'GET',
                        headers: {
                            Authorization: `KakaoAK ${KAKAO_REST_API_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        if (response.status === 403) {
                            throw new Error(`403 Forbidden: 카카오 개발자 센터에서 이 페이지의 도메인 등록을 확인하세요. (API 키 오류 또는 도메인 미등록)`);
                        } else if (response.status === 401) {
                            throw new Error(`401 Unauthorized: REST API 키가 올바른지 확인하세요.`);
                        }
                        throw new Error(`API 호출 실패: ${response.status} - ${errorBody}`);
                    }

                    const data = await response.json();
                    const documents = data.documents;
                    const meta = data.meta;
                    
                    documents.forEach(doc => {
                        const addressParts = doc.address_name.split(' ');
                        let district = '';
                        
                        // 읍/면/동/가 여부를 확인하는 필터
                        const isDistrict = (name) => name && (name.endsWith('읍') || name.endsWith('면') || name.endsWith('동') || name.endsWith('가'));

                        // 주소 파트에서 읍면동 추출 로직 (천안시 = 시(0) 구(1) 읍면동(2) 또는 시(0) 구(1) 구(2) 읍면동(3) 구조)
                        // 천안시는 '충청남도 천안시 서북구 두정동' 형태를 가집니다.
                        // 일반적으로 3번째 파트(index 2) 또는 4번째 파트(index 3)를 확인합니다.
                        
                        // 1. 4번째 파트 확인 (index 3: '두정동' 등) - 가장 일반적
                        if (addressParts.length > 3 && isDistrict(addressParts[3])) {
                            district = addressParts[3];
                        }
                        // 2. 3번째 파트 확인 (index 2: 구가 없을 경우 '읍'/'면' 등)
                        else if (addressParts.length > 2 && isDistrict(addressParts[2])) {
                            district = addressParts[2];
                        }

                        if (district) {
                            districts.add(district.trim());
                        }
                    });

                    if (meta.is_end === false) {
                        // API 연속 호출 간 부하 방지를 위해 짧은 지연 추가
                        await new Promise(resolve => setTimeout(resolve, 50)); 
                        return fetchAllDistricts(keyword, page + 1, districts);
                    } else {
                        return districts;
                    }

                } catch (error) {
                    console.error(`[지역 로드 에러]`, error.message);
                    // 에러 발생 시 현재까지 수집된 데이터 반환
                    return districts; 
                }
            }

            // -------------------- 렌더링 로직 --------------------
            /**
             * Select Box에 읍면동 목록을 렌더링합니다.
             * @param {Set<string>} districts - 수집된 지역 Set
             */
            function renderDistricts(districts) {
                // 로딩 옵션 제거 및 새로운 기본 옵션 추가
                dropdown.innerHTML = '';
                
                const finalDistrictList = Array.from(districts).sort();

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `지역 선택 (${finalDistrictList.length}개)`;
                defaultOption.selected = true;
                defaultOption.disabled = true;
                dropdown.appendChild(defaultOption);

                // 추출된 목록 추가
                finalDistrictList.forEach(district => {
                    const option = document.createElement("option");
                    option.value = district;
                    option.innerText = district;
                    dropdown.appendChild(option);
                });
                dropdown.disabled = false; // 드롭다운 활성화
            }

            // -------------------- 초기화 로직 --------------------
            /**
             * 지역 드롭다운 초기화 및 로드 시작
             */
            async function initRegionDropdown() {
                // API 키 유효성 검사
                if (KAKAO_REST_API_KEY === "YOUR_KAKAO_REST_API_KEY_HERE" || !KAKAO_REST_API_KEY || KAKAO_REST_API_KEY.length < 10) {
                    dropdown.innerHTML = '<option selected disabled value="">[오류] API 키를 유효한 값으로 설정해주세요.</option>';
                    dropdown.disabled = true;
                    console.error("REST API 키를 유효한 값으로 교체해야 합니다.");
                    return;
                }

                // 로딩 상태 표시
                dropdown.innerHTML = '<option selected disabled value="">-- 지역 정보 로드 중... --</option>';
                dropdown.disabled = true;

                const uniqueDistrictsSet = await fetchAllDistricts(SEARCH_KEYWORD, 1, new Set());

                if (uniqueDistrictsSet.size === 0) {
                    // API 호출은 실행되었으나 결과가 없거나 오류가 발생했을 경우 (에러 메시지는 fetchAllDistricts에서 출력됨)
                    dropdown.innerHTML = '<option selected disabled value="">[오류] 지역 목록을 가져올 수 없습니다.</option>';
                    dropdown.disabled = true;
                    return;
                }

                renderDistricts(uniqueDistrictsSet);
            }

            // 지역 로드 함수 실행
            initRegionDropdown();
        });

      // 가입 정보 검증
      const idInput = document.querySelector(".input-id");
      const idCheck = document.querySelector(".check-id");

      const mailInput = document.querySelector(".input-email");
      const mailCheck = document.querySelector(".check-email");

      const pwInput = document.querySelector(".input-pwd");
      const pwCheck = document.querySelector(".check-pwd");

      const pwcInput = document.querySelector(".input-pwd-check");
      const pwcCheck = document.querySelector(".check-pwd-check");

      const telInput = document.querySelector(".input-tel");
      const telCheck = document.querySelector(".check-tel");

      const regionInput = document.querySelector(".region");

      const mInput = document.getElementById("male");
      const fInput = document.getElementById("female");

      const sportRunning = document.getElementById('sportR');
      const sportWeight = document.getElementById('sportW');
      const sportAll = document.getElementById('sportA');

      const submitBtn = document.getElementById("signup-button");

      const regexId = /^\w{8,20}$/;
      const regexMail =
        /^[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/;
      const regexPw = /^(?=.*[a-zA-Z])(?=.*[!@#$%^*+=-])(?=.*[0-9]).{8,}$/;
      const regexTel = /^0\d{1,2}-\d{3,4}-\d{4}$/;

      // 조건식 검증
      const validate = (input, regex, el, okMsg, badMsg) => {
        const v = input.value.trim();

        if (v === "") {
          el.textContent = "";
          el.classList.remove("valid");
          return null;
        }
        if (regex.test(v)) {
          el.textContent = okMsg;
          el.style.color = "green";
          el.classList.add("valid");
          return true;
        } else {
          el.textContent = badMsg;
          el.style.color = "red";
          el.classList.remove("valid");
          return false;
        }
      };

      const pwdCheck = () => {
        if (pwcInput.value.trim() === "") {
          pwcCheck.textContent = "";
          pwcCheck.classList.remove("valid");
          return null;
        }
        if (pwInput.value === pwcInput.value) {
          pwcCheck.textContent = "비밀번호가 일치합니다."
          pwcCheck.style.color = "green";
          pwcCheck.classList.add("valid");
          return true;
        } else {
          pwcCheck.textContent = "비밀번호가 일치하지 않습니다.";
          pwcCheck.style.color = "red";
          pwcCheck.classList.remove("valid");
          return false;
        }
      }

      const gCheck = () => { return mInput.checked || fInput.checked; }

      const sportCheck = () => {
        return sportRunning.checked || sportWeight.checked || sportAll.checked
      }

      const rCheck = () => { return regionInput.value !== "" }

      // submit 활성화/비활성화
      const updateSubmitBtn = () => {
        const i = validate(
          idInput,
          regexId,
          idCheck,
          "사용 가능합니다.",
          "아이디는 밑줄을 포함한 영숫자 8~20자");
        const p = validate(
          pwInput,
          regexPw,
          pwCheck,
          "안전한 비밀번호입니다.",
          "대/소문자+숫자+특수문자 포함 8자 이상");
        const pc = pwdCheck();
        const m = validate(
          mailInput,
          regexMail,
          mailCheck,
          "사용 가능합니다.",
          "올바른 이메일 형식으로 입력해주세요.");
        const pn = validate(
          telInput,
          regexTel,
          telCheck,
          "사용 가능합니다.",
          " - 을 포함하여 올바른 휴대폰번호 형식으로 입력해주세요.");

        const g = gCheck();
        const s = sportCheck();
        const r = rCheck();

        submitBtn.disabled = !(i && p && pc && m && pn && g && s && r);
      };

      idInput.addEventListener("input", updateSubmitBtn);
      pwInput.addEventListener("input", updateSubmitBtn);
      pwcInput.addEventListener("input", updateSubmitBtn);
      mailInput.addEventListener("input", updateSubmitBtn);
      telInput.addEventListener("input", updateSubmitBtn);
      mInput.addEventListener("click", updateSubmitBtn);
      fInput.addEventListener("click", updateSubmitBtn);
      sportRunning.addEventListener("click", updateSubmitBtn);
      sportWeight.addEventListener("click", updateSubmitBtn);
      sportAll.addEventListener("click", updateSubmitBtn);
      regionInput.addEventListener("change", updateSubmitBtn)

      // 운동 종목 선택에 따라 페이스 입력란 보이기
      const paceBox = document.getElementById("signup-box-pace");
      const paceOpen = () => paceBox.style.display = 'flex';
      const paceClose = () => paceBox.style.display = 'none';

      sportRunning.addEventListener("click", paceOpen);
      sportWeight.addEventListener("click", paceClose);
      sportAll.addEventListener("click", paceOpen);
    </script>

    <script th:inline="javascript">
      /*<![CDATA[*/
      (function () {
        const input = document.getElementById('profileImageInput');
        const img = document.getElementById('avatarPreview');
        const label = document.getElementById('label-signup-profile');
        const button = document.getElementById('btn-upload-profile');

        // 서버에서 내려온 원본 이미지 경로 저장(없으면 빈 문자열)
        const originalSrc = /*[[${userForm != null}]]*/ false
          ? /*[[${userForm.profileImageUrl} != null ? @{/files/{file}(file=${userForm.profileImageUrl})} : @{/images/profile.png}]]*/ ''
          : '';

        let objectUrl = null;
        function revoke() {
          if (objectUrl) {
            URL.revokeObjectURL(objectUrl);
            objectUrl = null;
          }
        }

        // 커스텀 버튼을 클릭하면 file 업로드 시작
        button?.addEventListener('click', () => {
          input.click()
          console.log("버튼 클릭")
        });

        input?.addEventListener('change', function (e) {
          const file = e.target.files && e.target.files[0];
          if (!file) return;

          const okTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
          if (!okTypes.includes(file.type)) {
            alert('이미지 파일(JPG/PNG/WebP/GIF)만 업로드할 수 있습니다.');
            input.value = '';
            return;
          }
          if (file.size > 5 * 1024 * 1024) {
            alert('파일 용량은 5MB 이하만 가능합니다.');
            input.value = '';
            return;
          }

          revoke();
          objectUrl = URL.createObjectURL(file);
          img.src = objectUrl;
        });

        window.addEventListener('beforeunload', revoke);
      })();
      /*]]>*/
    </script>
  </div>
</body>

</html>