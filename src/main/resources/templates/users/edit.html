<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{/layout/main}"
>
<head>
    <meta charset="UTF-8" />
    <title>my info edit</title>
</head>
<body>
<div layout:fragment="content">
  <div id="my-edit-container">
  <h1>회원 정보 수정</h1>
  <form
                th:action="@{/users/{userNo}/edit(userNo=${userInfo.userNo})}"
                th:object="${userInfo}"
                method="post"
                enctype="multipart/form-data"
        >
    <div id="user-info-edit-container">
      <div id="profile-img-edit">
        <div class="profile-left">
            <div class="avatar-box">
                <img id="avatarPreview" class="avatar img-round-small"
                     th:src="${userInfo.profileImageUrl} != null ?
                        @{'/files/'+${userInfo.profileImageUrl}} :
                        @{/images/profile.png}"
                     alt="프로필 미리보기" />
            </div>
        </div>
      </div>
      <div id="profile-img-box">
          <p>프로필 사진</p>
          <div id="profile-img-button-box">
            <div id="profile-img-button">
              <label for="profileImageInput" >
              <button id="edit-profile-button" type="button">사진 변경</button>
              <input id="profileImageInput" type="file" name="profileImage" accept="image/*">
            </label>
            <label for="profileImageDelete">
              <button id="delete-profile-button" type="button">사진 삭제</button>
              <input id="profileImageDelete" name="is_image_delete_flag" type="hidden" value="false">
            </label>
            </div>
            <div class="hint">JPG/PNG/WebP 권장, 5MB 이하</div>
          </div>
        </div>
    </div>
      <table id="user-info-edit-table">
        <tr>
          <td>이름:</td>
          <td>
            <input type="text" class="input-txt" id="userNameInput" placeholder="변경할 이름을 입력해주세요." th:field="*{name}" required>
            <p class="signup-check"></p>
          </td>
        </tr>
        <tr>
          <td>아이디:</td>
          <td>
            <input type="text" class="input-txt input-id" placeholder="변경할 아이디를 입력해주세요." th:field="*{userId}" required>
            <p class="signup-check check-id"></p>
          </td>
        </tr>
        <tr>
          <td>이메일:</td>
          <td>
            <input type="text" class="input-txt input-email" placeholder="변경할 이메일을 입력해주세요." th:field="*{email}" required>
            <p class="signup-check check-email"></p>
          </td>
        </tr>
        <tr>
          <td>비밀번호:</td>
          <td>
            <input type="password" class="input-txt input-pwd" placeholder="변경할 비밀번호를 입력해주세요. (비워두면 기존 유지)" name="password">
            <p class="signup-check check-pwd"></p>
          </td>
        </tr>
        <tr>
          <td>비밀번호 확인:</td>
          <td>
            <input type="password" class="input-txt input-pwd-check" placeholder="비밀번호를 한번 더 입력해주세요.">
            <p class="signup-check check-pwd-check"></p>
          </td>
        </tr>
        <tr>
          <td>휴대폰번호:</td>
          <td>
            <input type="text" class="input-txt input-tel" placeholder="변경할 휴대폰번호를 입력해주세요." th:value="${userInfo.phoneNo}" th:field="*{phoneNo}" required>
            <p class="signup-check check-tel"></p>
          </td>
        </tr>
        <tr>
          <td>지역:</td>
          <td>
            <select name="region" id="select-region" class="region" th:field="*{region}">
              <option disabled hidden="hidden" value="">변경할 지역을 선택해주세요</option>
            </select>
        <p class="signup-check"></p>
          </td>
        </tr>
        <tr>
          <td>성별:</td>
          <td><p id="edit-gender" th:text="${userInfo.gender}"></p></td>
        </tr>
        <tr>
          <td>나이:</td>
          <td>
            <input type="text" id="userAgeInput" class="input-txt" placeholder="변경할 나이를 만 나이로 입력해주세요." th:field="*{age}" required>
        <p class="signup-check"></p>
          </td>
        </tr>
        <tr>
          <td>운동종목:</td>
          <td>
            <div id="edit-sport-box">
                <div class="choice">
                    <input type="radio" name="sport" id="sportR" th:field="*{sportType}" value="러닝" />러닝
                </div>
                <div class="choice">
                    <input type="radio" name="sport" id="sportW" th:field="*{sportType}" value="웨이트" />웨이트
                </div>
                <div class="choice">
                    <input type="radio" name="sport" id="sportA" th:field="*{sportType}" value="모두" />모두 선택
                </div>
            </div>
            <div class="hint hint-edit-sport">변경할 운동종목을 선택해주세요.</div>
          </td>
        </tr>
        <tr id="pace-box">
          <td>러닝페이스:</td>
          <td>
            <input type="text" class="input-txt" placeholder="MM:ss" th:field="*{paceDetail}"/>
            <p class="signup-check"></p>
          </td>
        </tr>
      </table>
    <div class="edit-button-box">
        <button type="submit" id="profile-update-button">회원정보수정</button>
        <button type="button" id="withdraw-button" class="btn-danger" >회원탈퇴</button>
    </div>
    </form>
    <form th:action="@{/users/{no}/delete(no=${userInfo.userNo})}" method="post" id="delete-form" style="display: none;"></form>
  </div>
    <script th:inline="javascript">
      // 가입 정보 검증
      const idInput = document.querySelector(".input-id");
      const idCheck = document.querySelector(".check-id");

      const mailInput = document.querySelector(".input-email");
      const mailCheck = document.querySelector(".check-email");

      const pwInput = document.querySelector(".input-pwd");
      const pwCheck = document.querySelector(".check-pwd");

      const pwcInput = document.querySelector(".input-pwd-check");
      const pwcCheck = document.querySelector(".check-pwd-check");

      const telInput = document.querySelector(".input-tel");
      const telCheck = document.querySelector(".check-tel");

      const regionInput = document.querySelector(".region");
      const sportRunning = document.getElementById('sportR');
      const sportWeight = document.getElementById('sportW');
      const sportAll = document.getElementById('sportA');

      const nameInput = document.getElementById('userNameInput');
      const ageInput = document.getElementById('userAgeInput');

      const submitBtn = document.getElementById("profile-update-button");

      const deleteButton = document.getElementById('withdraw-button');
      const deleteForm = document.getElementById('delete-form');

      deleteButton.addEventListener('click', () => {
        // 사용자에게 최종적으로 탈퇴 여부를 확인
        if (confirm('정말로 회원탈퇴를 하시겠습니까? 모든 정보가 삭제 처리되며 복구가 불가능할 수 있습니다.')) {
            // 확인을 누르면 숨겨진 폼을 전송 (POST 요청)
            deleteForm.submit();
        }
    });
      

      const regexId = /^\w{8,20}$/;
      const regexMail =
      /^[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/;
      const regexPw = /^(?=.*[a-zA-Z])(?=.*[!@#$%^*+=-])(?=.*[0-9]).{8,}$/;
      const regexTel = /^0\d{1,2}-\d{3,4}-\d{4}$/;
        
        // 💡 모든 필드가 유효한 상태인지 저장하는 플래그 객체 (초기값은 true로 설정)
        const validationFlags = {
            id: true, // 초기에는 기존 아이디가 유효하다고 가정
            password: true, // 비밀번호는 수정 시에만 검사하므로 true로 가정
            passwordConfirm: true, // 비밀번호는 수정 시에만 검사하므로 true로 가정
            email: true, // 초기에는 기존 이메일이 유효하다고 가정
            phoneNo: true, // 초기에는 기존 번호가 유효하다고 가정
            sport: true, // 초기에는 선택되어 있다고 가정
            region: true, // 초기에는 선택되어 있다고 가정
            // 참고: 이름과 나이는 required 속성으로 처리하고 validationFlags에는 포함하지 않음
        };

// 조건식 검증 - validate 함수는 유효성 여부만 반환하도록 수정
const validate = (input, regex, el, okMsg, badMsg) => {
const v = input.value.trim();

 if (v === "") {
 el.textContent = "";
 el.classList.remove("valid");
 // required가 아닌 필드(ex: 비밀번호)가 비어있으면 null 반환
 return input.hasAttribute('required') ? false : null;
 }
 if (regex.test(v)) {
 // 유효할 경우 메시지 표시
 el.textContent = okMsg;
 el.style.color = "green";
 el.classList.add("valid");
 return true;
 } else {
 // 유효하지 않을 경우 메시지 표시
 el.textContent = badMsg;
el.style.color = "red";
 el.classList.remove("valid");
 return false;
}};
        
        // 💡 필드별 검증 및 플래그 업데이트 함수
        const validateField = (input, regex, el, okMsg, badMsg, flagName) => {
            const result = validate(input, regex, el, okMsg, badMsg);
            
            if (result === null) {
                // 비어있는 경우 (비밀번호 같은 optional 필드) -> 유효성 통과로 간주
                validationFlags[flagName] = true;
            } else {
                validationFlags[flagName] = result;
            }
            updateSubmitBtn();
            return result;
        };

 const pwdCheck = () => {
const isPwEmpty = pwInput.value.trim() === "";
          const isPwcEmpty = pwcInput.value.trim() === "";

 if (isPwEmpty && isPwcEmpty) {
 pwcCheck.textContent = "";
pwcCheck.classList.remove("valid");
             validationFlags.passwordConfirm = true;
return true; // 둘 다 비어있으면 기존 유지로 통과
}
          
          if (isPwEmpty && !isPwcEmpty) {
            pwcCheck.textContent = "새 비밀번호를 입력하려면 비밀번호를 먼저 입력해주세요.";
 pwcCheck.style.color = "red";
 pwcCheck.classList.remove("valid");
            validationFlags.passwordConfirm = false;
            return false;
          }

          if (pwInput.value === pwcInput.value) {
 pwcCheck.textContent = "비밀번호가 일치합니다."
 pwcCheck.style.color = "green";
 pwcCheck.classList.add("valid");
             validationFlags.passwordConfirm = true;
 return true;
 } else {
 pwcCheck.textContent = "비밀번호가 일치하지 않습니다.";
pwcCheck.style.color = "red";
 pwcCheck.classList.remove("valid");
             validationFlags.passwordConfirm = false;
return false;
 }
 }

 const sportCheck = () => {
          const checked = sportRunning.checked || sportWeight.checked || sportAll.checked
          validationFlags.sport = checked;
          // 라디오 버튼은 체크 유무만 확인하고 메시지는 따로 출력하지 않음
 return checked
 }
        
        // 💡 region 변경 시 플래그 업데이트
 const rCheck = () => {
            const selected = regionInput.value !== ""
            validationFlags.region = selected;
            // 지역 선택은 메시지를 따로 출력하지 않음
            return selected
        }

 // submit 활성화/비활성화
const updateSubmitBtn = () => {
            // 이름, 나이 필드 검사 (required 속성만 의존)
            const nameValid = nameInput.value.trim() !== "";
            const ageValid = ageInput.value.trim() !== "";
            
            // 모든 플래그와 required 필드가 유효해야 버튼 활성화
 submitBtn.disabled = !(
                validationFlags.id && 
                validationFlags.password && 
                validationFlags.passwordConfirm && 
                validationFlags.email && 
                validationFlags.phoneNo && 
                validationFlags.sport && 
                validationFlags.region &&
                nameValid &&
                ageValid
            );
 };
        
        // 💡 이벤트 리스너: 각 필드 이벤트에만 validateField를 연결
        idInput.addEventListener("input", () => {
            validateField(idInput, regexId, idCheck, "사용 가능합니다.", "아이디는 밑줄을 포함한 영숫자 8~20자", 'id');
        });
        
        mailInput.addEventListener("input", () => {
            validateField(mailInput, regexMail, mailCheck, "사용 가능합니다.", "올바른 이메일 형식으로 입력해주세요.", 'email');
        });
        
        telInput.addEventListener("input", () => {
            validateField(telInput, regexTel, telCheck, "사용 가능합니다.", " - 을 포함하여 올바른 휴대폰번호 형식으로 입력해주세요.", 'phoneNo');
        });
        
        // 비밀번호 입력이 변경되면 비밀번호 유효성 검사 및 확인 검사
        pwInput.addEventListener("input", () => {
            const result = validateField(pwInput, regexPw, pwCheck, "안전한 비밀번호입니다.", "대/소문자+숫자+특수문자 포함 8자 이상", 'password');
            // 비밀번호를 입력하지 않았을 경우, 유효성 검사는 true를 반환하지만 확인 필드 검사는 필요함
            if (result !== false) {
                pwdCheck();
            }
        });

        // 비밀번호 확인 입력이 변경되면 확인 검사
 pwcInput.addEventListener("input", () => {
            pwdCheck();
            updateSubmitBtn();
        });
        
        // 이름, 나이 입력 시 버튼 상태 업데이트
       

// 이벤트 리스너
nameInput.addEventListener("input", updateSubmitBtn);
ageInput.addEventListener("input", updateSubmitBtn);
        

        // 💡 라디오 버튼/셀렉트 박스는 필드 메시지 없이 버튼 활성화만 담당 (기존의 sportCheck, rCheck 함수 내에서 플래그 업데이트)
 sportRunning.addEventListener("click", () => { sportCheck(); updateSubmitBtn(); paceOpen(); });
 sportWeight.addEventListener("click", () => { sportCheck(); updateSubmitBtn(); paceClose(); });
 sportAll.addEventListener("click", () => { sportCheck(); updateSubmitBtn(); paceOpen(); });
 regionInput.addEventListener("change", () => { rCheck(); updateSubmitBtn(); });
        
        // 페이지 로드 시 초기 유효성 검사 및 버튼 상태 설정
        document.addEventListener("DOMContentLoaded", () => {
            // 초기값을 플래그에 반영 (required 필드는 HTML required 속성에 의존)
            validateField(idInput, regexId, idCheck, "사용 가능합니다.", "아이디는 밑줄을 포함한 영숫자 8~20자", 'id');
            validateField(mailInput, regexMail, mailCheck, "사용 가능합니다.", "올바른 이메일 형식으로 입력해주세요.", 'email');
            validateField(telInput, regexTel, telCheck, "사용 가능합니다.", " - 을 포함하여 올바른 휴대폰번호 형식으로 입력해주세요.", 'phoneNo');
            
            // 비밀번호 필드는 비어있으므로 true로 유지.
            pwdCheck();
            
            // 라디오 버튼/지역 초기 선택 상태 반영
            sportCheck();
            rCheck();
            
            // 최종 버튼 상태 업데이트
            updateSubmitBtn();
        });

        // 운동 종목 선택에 따라 페이스 입력란 보이기
        const paceBox = document.getElementById("pace-box");

        const paceOpen = () => paceBox.style.display = 'table-row';
        const paceClose = () => paceBox.style.display = 'none';
        
        const currentSport = /*[[${userInfo.sportType}]]*/ '러닝';
        if (currentSport === '러닝' || currentSport === '모두') {
          paceOpen();
        } else {
          paceClose();
        }
      
        sportRunning.addEventListener("click", paceOpen);
        sportWeight.addEventListener("click", paceClose);
        sportAll.addEventListener("click", paceOpen);

        const regionValue = /*[[${userInfo.region}]]*/;

      document.addEventListener('DOMContentLoaded', () => {
            // -------------------- API 설정 --------------------
            // **주의: REST API 키는 서버 측에서 안전하게 관리하는 것이 좋습니다.**
            const KAKAO_REST_API_KEY = "d3a833eb2f6b0ab6fbf1d77ef93348aa";
            const SEARCH_KEYWORD = "천안시";
            const API_URL = "https://dapi.kakao.com/v2/local/search/keyword.json";
            const MAX_PAGES = 45; // 카카오 API 검색 페이지 수 제한 (최대 45)

            // DOM 요소 접근 (DOMContentLoaded 안에서 접근해야 null 오류가 발생하지 않습니다)
            const dropdown = document.getElementById("select-region");

            if (!dropdown) {
                console.error("오류: Select 박스 (ID: select_select)를 찾을 수 없습니다.");
                return; // 드롭다운이 없으면 나머지 로직 실행 중지
            }
            
            // 드롭다운 초기 상태 설정
            dropdown.disabled = true;

            // -------------------- 데이터 수집 로직 --------------------
            /**
             * 카카오 API를 재귀적으로 호출하여 모든 페이지의 지역 데이터를 수집합니다.
             * @param {string} keyword - 검색할 키워드 (예: "천안시")
             * @param {number} page - 현재 페이지 번호
             * @param {Set<string>} districts - 수집된 고유한 읍면동 이름을 저장하는 Set
             * @returns {Promise<Set<string>>} - 수집된 지역 Set
             */
            async function fetchAllDistricts(keyword, page, districts) {
                if (page > MAX_PAGES) {
                    console.warn(`최대 페이지 수(${MAX_PAGES}페이지)에 도달하여 검색을 중단합니다.`);
                    return districts;
                }

                const query = new URLSearchParams({
                    query: keyword,
                    page: page,
                    size: 15
                }).toString();

                try {
                    const response = await fetch(`${API_URL}?${query}`, {
                        method: 'GET',
                        headers: {
                            Authorization: `KakaoAK ${KAKAO_REST_API_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        if (response.status === 403) {
                            throw new Error(`403 Forbidden: 카카오 개발자 센터에서 이 페이지의 도메인 등록을 확인하세요. (API 키 오류 또는 도메인 미등록)`);
                        } else if (response.status === 401) {
                            throw new Error(`401 Unauthorized: REST API 키가 올바른지 확인하세요.`);
                        }
                        throw new Error(`API 호출 실패: ${response.status} - ${errorBody}`);
                    }

                    const data = await response.json();
                    const documents = data.documents;
                    const meta = data.meta;
                    
                    documents.forEach(doc => {
                        const addressParts = doc.address_name.split(' ');
                        let district = '';
                        
                        // 읍/면/동/가 여부를 확인하는 필터
                        const isDistrict = (name) => name && (name.endsWith('읍') || name.endsWith('면') || name.endsWith('동') || name.endsWith('가'));

                        // 주소 파트에서 읍면동 추출 로직 (천안시 = 시(0) 구(1) 읍면동(2) 또는 시(0) 구(1) 구(2) 읍면동(3) 구조)
                        // 천안시는 '충청남도 천안시 서북구 두정동' 형태를 가집니다.
                        // 일반적으로 3번째 파트(index 2) 또는 4번째 파트(index 3)를 확인합니다.
                        
                        // 1. 4번째 파트 확인 (index 3: '두정동' 등) - 가장 일반적
                        if (addressParts.length > 3 && isDistrict(addressParts[3])) {
                            district = addressParts[3];
                        }
                        // 2. 3번째 파트 확인 (index 2: 구가 없을 경우 '읍'/'면' 등)
                        else if (addressParts.length > 2 && isDistrict(addressParts[2])) {
                            district = addressParts[2];
                        }

                        if (district) {
                            districts.add(district.trim());
                        }
                    });

                    if (meta.is_end === false) {
                        // API 연속 호출 간 부하 방지를 위해 짧은 지연 추가
                        await new Promise(resolve => setTimeout(resolve, 50)); 
                        return fetchAllDistricts(keyword, page + 1, districts);
                    } else {
                        return districts;
                    }

                } catch (error) {
                    console.error(`[지역 로드 에러]`, error.message);
                    // 에러 발생 시 현재까지 수집된 데이터 반환
                    return districts; 
                }
            }

            // -------------------- 렌더링 로직 --------------------
            /**
             * Select Box에 읍면동 목록을 렌더링합니다.
             * @param {Set<string>} districts - 수집된 지역 Set
             */
            function renderDistricts(districts) {
                // 로딩 옵션 제거 및 새로운 기본 옵션 추가
                dropdown.innerHTML = '';
                
                const finalDistrictList = Array.from(districts).sort();

                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `지역 선택 (${finalDistrictList.length}개)`;
                defaultOption.selected = true;
                defaultOption.disabled = true;
                dropdown.appendChild(defaultOption);

                // 추출된 목록 추가
                finalDistrictList.forEach(district => {
                    const option = document.createElement("option");
                    option.value = district;
                    option.innerText = district;
                    dropdown.appendChild(option);
                });

                // 지역 선택 로직 (옵션 생성 후 실행)
                if (regionValue) {
                    dropdown.value = regionValue;
                    
                    // 선택이 제대로 되었는지 확인
                    if (dropdown.value === regionValue) {
                        console.log(`지역 설정 성공: ${regionValue}`);
                        // 이전에 '지역 선택'으로 설정된 기본 옵션을 해제 (사용자가 선택한 것처럼 보이게)
                        defaultOption.selected = false;
                    } else {
                        console.warn(`서버에서 받은 지역 값 '${regionValue}'이(가) 로드된 목록에 존재하지 않습니다.`);
                    }
                }
                dropdown.disabled = false; // 드롭다운 활성화
            }

            // -------------------- 초기화 로직 --------------------
            /**
             * 지역 드롭다운 초기화 및 로드 시작
             */
            async function initRegionDropdown() {
                // API 키 유효성 검사
                if (KAKAO_REST_API_KEY === "YOUR_KAKAO_REST_API_KEY_HERE" || !KAKAO_REST_API_KEY || KAKAO_REST_API_KEY.length < 10) {
                    dropdown.innerHTML = '<option selected disabled value="">[오류] API 키를 유효한 값으로 설정해주세요.</option>';
                    dropdown.disabled = true;
                    console.error("REST API 키를 유효한 값으로 교체해야 합니다.");
                    return;
                }

                // 로딩 상태 표시
                dropdown.innerHTML = '<option selected disabled value="">-- 지역 정보 로드 중... --</option>';
                dropdown.disabled = true;

                const uniqueDistrictsSet = await fetchAllDistricts(SEARCH_KEYWORD, 1, new Set());

                if (uniqueDistrictsSet.size === 0) {
                    // API 호출은 실행되었으나 결과가 없거나 오류가 발생했을 경우 (에러 메시지는 fetchAllDistricts에서 출력됨)
                    dropdown.innerHTML = '<option selected disabled value="">[오류] 지역 목록을 가져올 수 없습니다.</option>';
                    dropdown.disabled = true;
                    return;
                }

                renderDistricts(uniqueDistrictsSet);
            }

            // 지역 로드 함수 실행
            initRegionDropdown();
        });

        /*<![CDATA[*/
        (function() {
          const input = document.getElementById('profileImageInput');
          const img = document.getElementById('avatarPreview');
          const label = document.getElementById('label-signup-profile');
          const button = document.getElementById('edit-profile-button');

          const deleteButton = document.getElementById('delete-profile-button'); 
          const isImageDeletedInput = document.getElementById('profileImageDelete');

          // 서버에서 내려온 원본 이미지 경로 저장(없으면 빈 문자열)
          const originalSrc = /*[[${userInfo != null}]]*/ false
                  ? /*[[${userInfo.profileImageUrl} != null ? @{/files/{file}(file=${userInfo.profileImageUrl})} : @{/images/profile.png}]]*/ ''
                  : '';

          let objectUrl = null;
          function revoke() {
            if (objectUrl) {
              URL.revokeObjectURL(objectUrl);
              objectUrl = null;
            }
          }

          // 커스텀 버튼을 클릭하면 file 업로드 시작
          button?.addEventListener('click', () => {
            input.click()
            console.log("버튼 클릭")
          });

          input?.addEventListener('change', function(e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;

            const okTypes = ['image/jpeg','image/png','image/webp','image/gif'];
            if (!okTypes.includes(file.type)) {
              alert('이미지 파일(JPG/PNG/WebP/GIF)만 업로드할 수 있습니다.');
              input.value = '';
              return;
            }
            if (file.size > 5 * 1024 * 1024) {
              alert('파일 용량은 5MB 이하만 가능합니다.');
              input.value = '';
              return;
            }

            if(isImageDeletedInput) {
              isImageDeletedInput.value = 'false';
            }

            revoke();
            objectUrl = URL.createObjectURL(file);
            img.src = objectUrl;
          });

          deleteButton?.addEventListener('click', function() {
            if(isImageDeletedInput) {
              isImageDeletedInput.value = 'true';
            }

            input.value = '';

            img.src = /*[[@{/images/profile.png}]]*/;

            revoke();

            alert('프로필 사진이 기본 이비지로 변경됩니다.')
          })

          window.addEventListener('beforeunload', revoke);
        })();
        /*]]>*/
    </script>
</div>
</body>
</html>
